<metal:block metal:use-macro="here/main_template/macros/master">
<metal:block fill-slot="header" />
<metal:block 
  fill-slot="main"
  i18n:domain="cpsforum"
  tal:define="
    parent_id options/parent_id|nothing;
    comment_mode here/REQUEST/comment_mode|python:0;
    doc python:here.getForumObject(comment_mode=comment_mode);
    member python:here.portal_membership.getAuthenticatedMember();
    dtool python:here.portal_directories.members;
    errormsg options/error_message|nothing;
    is_poster python:member.has_permission('Forum Post', here);
    can_post python:here.isAllowedToPost(is_poster=is_poster,is_anon=isAnon)">

<tal:block tal:condition="not:can_post">
  <p i18n:translate="forum_post_unauthorize">You are not authorized to post on this forum</p>
</tal:block>

<tal:block tal:condition="python:comment_mode or can_post">
<form method="POST" action="." enctype="multipart/form-data">
  <table>
    <tr>
      <td i18n:translate="forum_author">Author</td>
      <td>
        <tal:block condition="not:here/portal_membership/isAnonymousUser">
          <tal:block define="
            user_id member/getUserName;
            user_props python:dtool.getEntry(user_id);
            fullname python:user_props and user_props.get(dtool.title_field, user_id) or user_id;">
            <input type="hidden" name="author:string"
                   tal:attributes="value user_id" />
            <span tal:replace="fullname" />
          </tal:block>
        </tal:block>

        <tal:block condition="here/portal_membership/isAnonymousUser">
          <input type="text" name="author:string" value="" />
          <span tal:condition="errormsg" tal:content="errormsg" 
                class="forumerror" />
        </tal:block>
      </td>
    </tr>
    <tr tal:define="parent_info python:parent_id and doc[parent_id];
                    parent_subject python:parent_info and parent_info['subject'];">
      <td i18n:translate="forum_subject">Subject</td>
      <td>
        <tal:block condition="parent_subject">
          <input type="text" name="subject:string"
                 tal:attributes="value string:Re: ${parent_subject};" />
        </tal:block>
        <tal:block condition="not:parent_subject">
          <input type="text" name="subject:string" />
        </tal:block>
        
      </td>
    </tr>
    <tr>
      <td i18n:translate="forum_message">Message</td>
      <td>
        <textarea cols="72" rows="20"
                  name="message:string"></textarea>
      </td>
    </tr>
    <tr>
      <td></td>
      <td>
        <input type="hidden" name="parent_id:string"
               tal:attributes="value parent_id">
        <input type="hidden" name="comment_mode:int"
               tal:attributes="value comment_mode" />
        <input type="submit" name="forum_post:method"
               class="standalone" value="forum_post" 
               i18n:attributes="value" />
      </td>
    </tr>
  </table>
</form>
</tal:block>
</metal:block>
</metal:block>
